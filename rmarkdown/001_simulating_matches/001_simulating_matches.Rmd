---
title: "How good do you have to be to win a tennis match?"
date: "March 2022"
output: 
  html_document:
    theme: united
urlcolor: blue
---

```{r,include=FALSE}
# This is needed to set the directory for all subsequent chunks
knitr::opts_knit$set(root.dir = '/Users/williammunn/Documents/github/tennis/functions/')
```

```{r,include=FALSE}
library(data.table)
library(ggplot2)
library(scales)
source("simulate_match.R")
#source("/Users/williammunn/Documents/github/tennis/rmarkdown/001_simulating_matches/001_simulating_matches.R",local = knitr::knit_global())
```

*The analysis in this post uses Jeff Sackmann's [repository of match data](https://github.com/JeffSackmann/tennis_atp)*

At the Monte Carlo Masters in 2017, Diego Schwartzman managed a victory over Roberto Bautista Agut, despite winning only 48% of his own points on serve. To claim so few points on your own serve would typically seal your fate in a professional tennis match. However, offsetting this was some incredible returning that saw him take 62% of points on his spanish rival's own serve.

At the other end of the spectrum: in 2019, at the New York Open, Reilly Opelka eventually edged out his compatriot John Isner. Unsurprisingly, given a match up between the two, the match was completely serve dominated (this occasion saw the Americans shatter the record for most aces in a best of three match, with a combined total of 81). In fact, despite winning 80% of his own service points, Isner could only manage a paltry 13% of points won on return (compared with Opelka's still-laughable 19%).

Matches like these two are extreme cases - and indeed, the tour average since 2010 for winners has been 69%/42% for serve and return points won - but they do suggest that, in order to win a tennis match, your combined serving and returning performance needs to be *good*. But how good is good enough?

### Playing tennis matches using R

Here are some R functions I've developed that will help.

The first is `play.point()`, which takes in a the name of the server (needs to be either "P1" or "P2"), and the average percentage of points that player wins on their serve. We could "simulate" a single point from Isner in his match above like this:

```{r}
play.point("P1",0.8)
```

The `play.point()` functions depends on a random number being drawn each time it gets invoked. So, while our R version of  Isner will still lose the odd point, he should, on average, win on his serve four out of five times. A larger number of simulations shows this:

```{r}
# show that play.point is eventually right
outcomes <- sapply(1:10000, function(x) play.point("P1",0.8))
win_percent <- sum(outcomes == "P1")/length(outcomes)
percent(win_percent)
```

Next up are basically a bunch of logical extensions to our simulations: we can play games using `play.game()`, sets using `play.set()`, and matches using `play.match`. You can even get R to play a single tiebreak using `play.tiebreak()`. These functions rely on each other, just like in an actual game, set, or match of tennis.

All functions bar `play.point()` return a list consisting of two outputs. The first is simply the winner of whatever was just played - always either "P1" or "P2". The second is a data framr storing the *outcome* of each point. This is interesting for gathering data about the matches played, and we can use this data to generate statistics - % of points won on serve, break points generated and saved, and so on.

Here is a recreation of a match between two serve-oriented ('servebots', in today's parlance) players like Isner and Opelka:

```{r}
# a match between two players who win around 80% of points won on serve
result <- play.match(3,"P1",0.8,0.8)
# winner
result[[1]]
# first and last few points
rbind(head(result[[2]],4),tail(result[[2]],4))
```

```{r,include=FALSE}
# Number of games that featured a deuce
deuces <- setDT(result[[2]])[,`:=`(
  p1.points = cumsum(winner == 'P1'),
  p2.points = cumsum(winner == 'P2')),
  by = .(set_number,game_number)
  ][p1.points == 3 & p2.points == 3,.N, by = .(set_number,game_number)
    ][,.N]
```

This best of 3 set match lasted a total of `r nrow(result[[2]])` points. It only featured `r deuces` games that went to deuce. In fact, after 1,000 matches between two strong servers like Isner/Opelka, we only see an average of 3.2 games go to deuce per match. Compare this to two players with much more mediocre serving (or strong returning), like we saw back in Schwartzman and Bautista Agut, and we'd see an average of 7.6 games per match go to deuce.

All of which is to say that these tennis-playing R functions are good for confirming the basic intuitions that most people already hold about tennis.

### When serving well serves no real purpose

It's clearly helpful if you can serve with the kind of effectiveness that we've come to expect from Isner, Opelka, Kyrgios *et al*, but these serve-centric players often have little to no return game. They might win almost every service game, but equally, they'll hardly ever make inroads against even moderately-serving opponents, leading to inevitable tiebreaks. If a player like Isner could somehow give up a small amount of effectiveness on his serve and *gain* some returning skill, would it help him win more matches?

When I wrote this article, Isner had played 10 matches in 2022, but had averaged 75% of service points won - higher than any other season (his next best effort of 74.7% was in 2019). According to the computer, a player with these numbers can expect to win more than 95% of his service games. So far this season, Isner has held serve 149 out of 156 times, which agrees with the model.

It shouldn't come as a surprise that winning three-quarters of points on serve amounts to a nearly unbreakable serve. After all, a game simply amounts to a bunch of service points. When you're winning three-quarters of those individual points, an opponent has a nearly zero chance of stringing together the minimum of four points *against* the server that are required for a break of serve. If more than four points was required to win a game, the effect would be even stronger.

The opposite is true for a player who wins less than 50% of points on serve - they pay the price in terms of their percentage of service games held.

And, as for a player than wins exactly half their points on serve, we'd expect them to hold serve exactly half the time, as well. This snippet of code, and the table it produces, illustrates simalated probabilities of holding serve:

```{r}
# simulated probability of holding serve
serve_pct <- rep(c(0.1,0.25,0.5,0.75,0.9),1000)
outcomes <- sapply(serve_pct,function(x) play.game("P1",x)[[1]])
data.table(points_pct = serve_pct, winner = outcomes)[,.(games_pct = sum(winner=="P1")/.N),by=points_pct]
```

By the time a player gets to a very high percentage of service points won, the marginal gain from serving a little better, or a little worse, is small. In the case of Isner, with his numbers of 75%, the trade-off is around 1:1. With a 5% drop is service *points* won, he'd see about an equivalent drop in service *games* won - surprisingly. So, maybe it's worth keeping up his serving practise, after all.

What about Isner's return game? 

